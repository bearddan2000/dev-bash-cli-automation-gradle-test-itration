plugins {
  id 'com.github.ben-manes.versions' version '0.13.0' // gradle dependencyUpdates
  id 'se.thinkcode.cucumber-runner' version '0.0.8'
  id 'io.qameta.allure' version '2.8.1'
}

apply plugin: 'java'
apply plugin: 'application'

targetCompatibility = sourceCompatibility = JavaVersion.VERSION_1_8

group = group

jar {
  version = version
  baseName = baseName
}

repositories {
  jcenter()
  mavenCentral()
}

test {
    useTestNG() {
        useDefaultListeners = true
    }
    reports {
        // turn off Gradle's HTML report to avoid replacing the
        // reports generated by TestNG library
        reports.html.enabled = false
    }

    // Show test results.
    testLogging {
        events "passed", "skipped", "failed"
    }
}

ext {
  allureVersion = '2.8.1'
  allurePluginVersion = '2.13.6'
  cucumberVersion = '6.0.0'
  lombokVersion = '1.18.22'
  springVersion = '5.0.1.RELEASE'
}

dependencies {

  compileOnly "org.projectlombok:lombok:${lombokVersion}"
  annotationProcessor "org.projectlombok:lombok:${lombokVersion}"

 testCompileOnly "org.projectlombok:lombok:${lombokVersion}"
 testAnnotationProcessor "org.projectlombok:lombok:${lombokVersion}"

  testImplementation "org.mockito:mockito-all:1.9.5"

    testImplementation "io.cucumber:cucumber-java:${cucumberVersion}"
    testImplementation "io.cucumber:cucumber-core:${cucumberVersion}"
  testImplementation "io.cucumber:cucumber-testng:${cucumberVersion}"

  testImplementation "io.qameta.allure:allure-cucumber6-jvm:${allurePluginVersion}"

  implementation "org.springframework:spring-context:${springVersion}"
  testImplementation "org.springframework:spring-test:${springVersion}"
}

configurations {
    cucumberRuntime {
        extendsFrom testImplementation
    }
    testCompile
}

task cucumberCli() {
    dependsOn assemble, testClasses
    doLast {
        javaexec {
            systemProperty("allure.results.directory", "build/allure-results")
            main = "io.cucumber.core.cli.Main"
            classpath = configurations.cucumberRuntime + sourceSets.main.output + sourceSets.test.output
            args = ['--plugin', 'pretty',
                    '--plugin', 'io.qameta.allure.cucumber6jvm.AllureCucumber6Jvm']
        }
    }
}

cucumber {
    main = "io.cucumber.core.cli.Main"
}

allure {
    version = allureVersion
    autoconfigure = true
    aspectjweaver = true
    configuration = "testImplementation"
}

cucumberCli.finalizedBy 'allureReport'
